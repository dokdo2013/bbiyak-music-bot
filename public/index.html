<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì‚ì•½ì‚ì•½ Web</title>
  <link rel="shortcut icon" href="bby.jpeg" type="image/x-icon">
  <style>
    button.primary {
        background-color: #4CAF50;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
    }

    button.danger {
        background-color: white;
        border: 1px solid #f44336;
        color: #f44336;
        padding: 2px 6px;
        border-radius: 4px;
        cursor: pointer;
    }

    ol {
      line-height: 1.5;
    }
    li {
      font-size: 1.3rem;
    }
  </style>

  <!-- Socket.io CDN -->
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js" crossorigin="anonymous"></script>

  <!-- toastr CSS/JS (í† ìŠ¤íŠ¸ ë©”ì‹œì§€ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

  <!-- Pretendard -->
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.min.css" />

  <style>
    /* toastr ìœ„ì¹˜ë¥¼ ìš°ì¸¡ ìƒë‹¨ìœ¼ë¡œ ì„¤ì • */
    #toast-container > div {
      top: 1em !important;
      right: 1em !important;
    }

    html, body, * {
        font-family: 'Pretendard', sans-serif;
    }
  </style>
</head>

<body>
  <main style="display: flex; gap: 15px; margin-top: 10px">
    <section style="max-width: 448px;">
      <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px">
        <img src="/bby.jpeg" alt="ì‚ì•½ì‚ì•½" style="width: 45px; height: 45px; border-radius: 8px">

        <h1 style="margin: 0">ì‚ì•½ì‚ì•½ ë…¸ë˜ì‹ ì²­ë´‡</h1>

        <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
        <div style="">
          <div id="connected" style="display: none">ğŸŸ¢</div>
          <div id="disconnected">
            <span>ğŸ”´</span>
            <button onclick="window.location.reload();">Reload</button>
          </div>
        </div>
      </div>

      <div style="margin-top: 20px">
        <div style="color: #999; margin-bottom: 4px;">ğŸµ NOW PLAYING</div>
        <div id="now_song" style="font-weight: bold; font-size: 1.2rem">NONE</div>
      </div>

      <!-- ìœ íŠœë¸Œ í”Œë ˆì´ì–´ê°€ ì‚½ì…ë  div (IFrame Player APIê°€ ë‚´ë¶€ì ìœ¼ë¡œ iframeì„ ìƒì„±) -->
      <div id="player" style="width: 448px; height: 252px; background-color: #000; margin-top: 20px"></div>

      <div style="margin-top: 10px">
        <!-- Next Item ë²„íŠ¼ ì¶”ê°€ -->
        <button class="primary" onclick="skipItem()">Skip Video</button>
      </div>

    </section>

    <section style="margin-right: 10px">
      <div style="padding: 10px 15px; background-color: #ddd; border-radius: 8px">
        <div style="font-size: 1.25rem; text-align: center">
          ë…¸ë˜ ì‹ ì²­ì€ <span style="font-weight: bold">ììœ ê²Œì‹œíŒ > 'ì‹ ì²­ê³¡ ë°›ìŠµë‹ˆë‹¹'</span> ìŠ¤ë ˆë“œì—ì„œ!
        </div>
      </div>


      <!-- í í‘œì‹œ ì˜ì—­ -->
      <div id="queue" style="display: flex; align-items: flex-start; gap: 8px">
        <div style="display: flex; flex-direction: column; gap: 8px; min-width: 70px">
          <h2>ì‹ ì²­ê³¡</h2>
        </div>
        <ol id="queue-list"></ol>
      </div>
    </section>
  </main>


  <script>
    // ---------------------------------------------
    // 1. ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸° ë¡œì§
    // ---------------------------------------------
    let player;                      // YT.Player ê°ì²´
    let queue = JSON.parse(localStorage.getItem('videoQueue')) || [];
    const socket = io();
    const queueList = document.getElementById('queue-list');

    // toastr ì˜µì…˜ ì„¤ì • (ì›í•˜ì‹œë©´ ë¬¸êµ¬/ì•„ì´ì½˜ ë“±ì„ ì¡°ì •í•´ì£¼ì„¸ìš”)
    toastr.options = {
      "closeButton": false,
      "debug": false,
      "newestOnTop": true,
      "progressBar": true,
      "positionClass": "toast-top-right",
      "timeOut": "10000"
    };

    // ---------------------------------------------
    // 2. YouTube IFrame API ìŠ¤í¬ë¦½íŠ¸ ë™ì  ë¡œë“œ
    // ---------------------------------------------
    // ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•˜ë©´ ê¸€ë¡œë²Œ ìŠ¤ì½”í”„ì˜ onYouTubeIframeAPIReady()ë¥¼ ìë™ í˜¸ì¶œí•¨
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    // ---------------------------------------------
    // 3. onYouTubeIframeAPIReady - ì „ì—­ í•¨ìˆ˜
    // ---------------------------------------------
    // IFrame API ì¤€ë¹„ ì™„ë£Œ ì‹œ ìë™ í˜¸ì¶œ => ì—¬ê¸°ì„œ playerë¥¼ ì´ˆê¸°í™”
    window.onYouTubeIframeAPIReady = function () {
      player = new YT.Player('player', {
        // playerVars ì˜µì…˜ì„ í†µí•´ ì¬ìƒ/ì»¨íŠ¸ë¡¤ ë°” ì œì–´ ê°€ëŠ¥
        playerVars: {
          autoplay: 0,  // ìë™ ì¬ìƒ(1)í• ì§€ ì—¬ë¶€
          controls: 1,  // í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤(ì¬ìƒ/ì¼ì‹œì •ì§€ ë²„íŠ¼ ë“±) í‘œì‹œ ì—¬ë¶€
        },
        events: {
          onReady: onPlayerReady,
          onStateChange: onPlayerStateChange,
        },
      });
    };

    // ---------------------------------------------
    // 4. í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ëì„ ë•Œ ì½œë°±
    // ---------------------------------------------
    function onPlayerReady(event) {
      console.log('Player is ready!');
      toastr.success("í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!");

      // íì— ì˜ìƒì´ ìˆìœ¼ë©´ ì²« ì˜ìƒì„ ì¬ìƒ
      if (queue.length > 0) {
        playNext();
      }
    }

    // ---------------------------------------------
    // 5. í”Œë ˆì´ì–´ ìƒíƒœ ë³€í™” ì½œë°±
    // ---------------------------------------------
    function onPlayerStateChange(event) {
      // ì˜ìƒì´ ëë‚¬ë‹¤ë©´
      if (event.data === YT.PlayerState.ENDED) {
        // í˜„ì¬ ì˜ìƒ íì—ì„œ ì œê±° í›„ ë‹¤ìŒ ì˜ìƒ ì¬ìƒ
        queue.shift();
        localStorage.setItem('videoQueue', JSON.stringify(queue));
        updateQueueUI();

        toastr.info("ì˜ìƒì´ ì¢…ë£Œë˜ì–´ ë‹¤ìŒ ì˜ìƒìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.");
        playNext();
      }
    }

    // ---------------------------------------------
    // 6. ì˜ìƒ ì¬ìƒ í•¨ìˆ˜
    // ---------------------------------------------
    // íì—ì„œ ì²« ì˜ìƒì„ êº¼ë‚´ ì¬ìƒ
    function playNext() {
      if (!player || queue.length === 0) return;

      const firstUrl = queue[0];
      const videoId = extractVideoId(firstUrl);

      // í•„ìš”í•œ ê²½ìš°, startSeconds, endSeconds, quality ë“± ì¶”ê°€ ê°€ëŠ¥
      player.loadVideoById(videoId);
      toastr.info(`ë‹¤ìŒ ì˜ìƒ ì¬ìƒ ì¤‘: ${firstUrl}`);
    }

    // ---------------------------------------------
    // 7. videoId ì¶”ì¶œ ìœ í‹¸ í•¨ìˆ˜ (ê°„ë‹¨ ë²„ì „)
    // ---------------------------------------------
    // ì˜ˆ: https://www.youtube.com/watch?v=abc123 => abc123
    //     https://youtu.be/abc123                => abc123
    //     https://www.youtube.com/embed/abc123   => abc123
    // ì •ê·œì‹/ë¬¸ìì—´ íŒŒì‹± ë“± ë°©ì‹ì€ ììœ ë¡­ê²Œ ì ìš©
    function extractVideoId(url) {
      // 1) watch?v= í˜•ì‹
      let match = url.match(/[?&]v=([^&]+)/);
      if (match && match[1]) {
        return match[1];
      }
      // 2) /embed/ í˜•ì‹
      match = url.match(/\/embed\/([^?/]+)/);
      if (match && match[1]) {
        return match[1];
      }
      // 3) youtu.be/ í˜•ì‹
      match = url.match(/youtu\.be\/([^?/]+)/);
      if (match && match[1]) {
        return match[1];
      }

      // ëª» ì°¾ìœ¼ë©´ í†µì§¸ë¡œ ë°˜í™˜(ê¸°ë³¸ê°’)
      return url;
    }

    // ---------------------------------------------
    // 8. UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    // ---------------------------------------------
    function updateQueueUI() {
      queueList.innerHTML = '';

      // ê° urlì— ëŒ€í•´ fetch Promiseë¥¼ ìƒì„±
      const promises = queue.map((url, index) => {
        return fetch(`/video?url=${url}`)
          .then((res) => res.json())
          .then((data) => {
            return { title: data.title || 'Unknown', index };
          })
          .catch((err) => {
            console.error(err);
            return { title: 'Unknown', index };
          });
      });

      // ëª¨ë“  ìš”ì²­ì´ ëë‚œ í›„ ìˆœì„œëŒ€ë¡œ liì— ì¶”ê°€
      Promise.all(promises).then((results) => {
        results.forEach(({ title, index }) => {
          const li = document.createElement('li');
          li.innerHTML = `
            ${title}
            <button class="danger" onclick="removeFromQueue(${index})">ì‚­ì œ</button>
          `;
          queueList.appendChild(li);
        });

        // #now_song ì—…ë°ì´íŠ¸
        document.getElementById('now_song').textContent = results[0]?.title || 'NONE';
      });
    }


    // (ì‚­ì œ) ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ í•­ëª©ì„ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜
    function removeFromQueue(index) {
      queue.splice(index, 1);
      localStorage.setItem('videoQueue', JSON.stringify(queue));
      updateQueueUI();
      toastr.warning("í•´ë‹¹ ì˜ìƒì´ íì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // ---------------------------------------------
    // 9. ì†Œì¼“ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    // ---------------------------------------------
    socket.on('new_video', (url) => {
      // ìƒˆ ë§í¬ê°€ ë“¤ì–´ì˜¤ë©´ íì— ì¶”ê°€ í›„, ë¹„ì–´ìˆì—ˆë‹¤ë©´ ë°”ë¡œ ì¬ìƒ
      queue.push(url);
      localStorage.setItem('videoQueue', JSON.stringify(queue));
      updateQueueUI();

      toastr.success("ìƒˆ ì˜ìƒì´ íì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");

      // í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ëê³ , í˜„ì¬ ì˜ìƒì´ ì—†ëŠ” ìƒíƒœë¼ë©´ ì¬ìƒ
      if (player && queue.length === 1) {
        playNext();
      }
    });

    socket.on('connect', () => {
      document.getElementById('connected').style.display = 'block';
      document.getElementById('disconnected').style.display = 'none';
      toastr.success("ì„œë²„ì™€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!");
    });

    socket.on('disconnect', () => {
      document.getElementById('connected').style.display = 'none';
      document.getElementById('disconnected').style.display = 'block';
      toastr.error("ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤...");
      console.log('Disconnected from server. Attempting to reconnect...');
      setTimeout(() => socket.connect(), 3000);
    });

    // ---------------------------------------------
    // 10. í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì„¤ì •
    // ---------------------------------------------
    updateQueueUI();
    // ì—¬ê¸°ì„œ ë°”ë¡œ playNext()ë¥¼ í˜¸ì¶œí•´ë„ ë˜ì§€ë§Œ, ì‹¤ì œ í”Œë ˆì´ì–´ëŠ” onPlayerReady ë•Œ ì²˜ë¦¬

    // ---------------------------------------------
    // 11. Next Item ë²„íŠ¼ìš© í•¨ìˆ˜ (í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ì˜ìƒ ë„˜ì–´ê°€ê¸°)
    // ---------------------------------------------
    function skipItem() {
      if (queue.length > 0) {
        // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ í•­ëª©ì„ ì œê±°í•œ ë’¤ì— ë‹¤ìŒ ì¬ìƒ
        queue.shift();
        localStorage.setItem('videoQueue', JSON.stringify(queue));
        updateQueueUI();
        toastr.info("í˜„ì¬ ì•„ì´í…œì„ ìŠ¤í‚µí•˜ê³  ë‹¤ìŒ ì˜ìƒìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.");
        playNext();
      } else {
        toastr.warning("ë” ì´ìƒ ì¬ìƒí•  ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
      }
    }
  </script>
</body>
</html>
